<div class="symbol-tracker-container">
  <div class="tracker-header">
    <h3>Symbol Price Tracker</h3>
    <div class="controls">
      <!-- Symbol Selector -->
      <div class="control-group">
        <label>Symbol:</label>
        <select [(ngModel)]="selectedSymbol" (change)="changeSymbol(selectedSymbol)" class="symbol-select">
          <option *ngFor="let symbol of availableSymbols" [value]="symbol">{{ symbol }}</option>
        </select>
      </div>

      <!-- Time Frame Selector -->
      <div class="control-group">
        <label>Time Range:</label>
        <div class="time-frame-buttons">
          <button
            *ngFor="let tf of timeFrames"
            [class.active]="selectedTimeFrame === tf.value"
            (click)="changeTimeFrame(tf.value)"
            class="time-frame-button">
            {{ tf.label }}
          </button>
        </div>
      </div>

      <!-- Advanced Options Toggle -->
      <div class="control-group">
        <button class="advanced-toggle" (click)="toggleAdvancedOptions()">
          {{ showAdvancedOptions ? '▼' : '▶' }} Advanced Indicators
        </button>
      </div>
    </div>

    <!-- Advanced Options Panel -->
    <div class="advanced-options-panel" *ngIf="showAdvancedOptions">
      <div class="advanced-options-grid">
        <label class="indicator-checkbox">
          <input type="checkbox" [(ngModel)]="advancedOptions.showKfRegime" (change)="onAdvancedOptionChange()">
          <span>KF Regime (Bull/Bear/Chop)</span>
        </label>
        <label class="indicator-checkbox">
          <input type="checkbox" [(ngModel)]="advancedOptions.showKfVelocity" (change)="onAdvancedOptionChange()">
          <span>KF Velocity</span>
        </label>
        <label class="indicator-checkbox">
          <input type="checkbox" [(ngModel)]="advancedOptions.showDelta15s2" (change)="onAdvancedOptionChange()">
          <span>Delta 15s</span>
        </label>
        <label class="indicator-checkbox">
          <input type="checkbox" [(ngModel)]="advancedOptions.showDelta1m" (change)="onAdvancedOptionChange()">
          <span>Delta 1m</span>
        </label>
        <label class="indicator-checkbox">
          <input type="checkbox" [(ngModel)]="advancedOptions.showDelta5m" (change)="onAdvancedOptionChange()">
          <span>Delta 5m</span>
        </label>
        <label class="indicator-checkbox">
          <input type="checkbox" [(ngModel)]="advancedOptions.showCvd1m" (change)="onAdvancedOptionChange()">
          <span>CVD 1m</span>
        </label>
      </div>
    </div>
  </div>

  <div *ngIf="loading" class="loading-spinner">
    <div class="spinner"></div>
    <p>Loading price data...</p>
  </div>

  <div *ngIf="error && !loading" class="error-alert">
    <span class="error-icon">⚠️</span>
    {{ error }}
  </div>

  <div *ngIf="!loading && !error && symbolData">
    <!-- Price Statistics -->
    <div class="stats-grid">
      <div class="stat-card" *ngIf="getCurrentPrice() as price">
        <div class="stat-label">Current Price</div>
        <div class="stat-value price-value">${{ price.toFixed(2) }}</div>
      </div>

      <div class="stat-card" *ngIf="getPriceChange() as change">
        <div class="stat-label">Change</div>
        <div class="stat-value" [ngClass]="change.isPositive ? 'positive' : 'negative'">
          {{ change.isPositive ? '+' : '' }}${{ change.change.toFixed(2) }}
          <span class="percent">({{ change.isPositive ? '+' : '' }}{{ change.changePercent.toFixed(2) }}%)</span>
        </div>
      </div>

      <div class="stat-card" *ngIf="getHigh() as high">
        <div class="stat-label">High</div>
        <div class="stat-value">${{ high.toFixed(2) }}</div>
      </div>

      <div class="stat-card" *ngIf="getLow() as low">
        <div class="stat-label">Low</div>
        <div class="stat-value">${{ low.toFixed(2) }}</div>
      </div>

      <div class="stat-card" *ngIf="getVolume() as volume">
        <div class="stat-label">Total Volume</div>
        <div class="stat-value volume-value">{{ volume.toLocaleString() }}</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">Data Points</div>
        <div class="stat-value">{{ symbolData.bars.length }}</div>
      </div>
    </div>

    <!-- Price Chart -->
    <div class="chart-container">
      <canvas #priceChart (contextmenu)="onChartRightClick($event)"></canvas>
    </div>

    <!-- Right-click Context Menu -->
    <div class="context-menu"
         *ngIf="contextMenu.show && contextMenu.data"
         [style.left.px]="contextMenu.x"
         [style.top.px]="contextMenu.y">
      <div class="context-menu-header">{{ contextMenu.data.timestamp }}</div>
      <div class="context-menu-section">
        <div class="context-menu-title">Price</div>
        <div class="context-menu-row">
          <span>Open:</span><span>${{ contextMenu.data.price?.open?.toFixed(2) }}</span>
        </div>
        <div class="context-menu-row">
          <span>High:</span><span>${{ contextMenu.data.price?.high?.toFixed(2) }}</span>
        </div>
        <div class="context-menu-row">
          <span>Low:</span><span>${{ contextMenu.data.price?.low?.toFixed(2) }}</span>
        </div>
        <div class="context-menu-row">
          <span>Close:</span><span>${{ contextMenu.data.price?.close?.toFixed(2) }}</span>
        </div>
        <div class="context-menu-row">
          <span>Volume:</span><span>{{ contextMenu.data.volume?.toLocaleString() }}</span>
        </div>
      </div>
      <div class="context-menu-section" *ngIf="contextMenu.data.kfVelocity !== undefined || contextMenu.data.kfRegime !== undefined || contextMenu.data.delta15s2 !== undefined || contextMenu.data.delta1m !== undefined || contextMenu.data.delta5m !== undefined || contextMenu.data.cvd1m !== undefined">
        <div class="context-menu-title">Indicators</div>
        <div class="context-menu-row" *ngIf="contextMenu.data.kfRegime !== undefined">
          <span>KF Regime:</span><span class="regime-value">{{ getRegimeLabel(contextMenu.data.kfRegime) }}</span>
        </div>
        <div class="context-menu-row highlight" *ngIf="contextMenu.data.kfVelocity !== undefined">
          <span>KF Velocity:</span><span class="velocity-value">{{ contextMenu.data.kfVelocity !== null ? contextMenu.data.kfVelocity.toFixed(4) : 'N/A' }}</span>
        </div>
        <div class="context-menu-row" *ngIf="contextMenu.data.delta15s2 !== undefined">
          <span>Delta 15s:</span><span>{{ contextMenu.data.delta15s2 !== null ? contextMenu.data.delta15s2.toFixed(0) : 'N/A' }}</span>
        </div>
        <div class="context-menu-row" *ngIf="contextMenu.data.delta1m !== undefined">
          <span>Delta 1m:</span><span>{{ contextMenu.data.delta1m !== null ? contextMenu.data.delta1m.toFixed(0) : 'N/A' }}</span>
        </div>
        <div class="context-menu-row" *ngIf="contextMenu.data.delta5m !== undefined">
          <span>Delta 5m:</span><span>{{ contextMenu.data.delta5m !== null ? contextMenu.data.delta5m.toFixed(0) : 'N/A' }}</span>
        </div>
        <div class="context-menu-row" *ngIf="contextMenu.data.cvd1m !== undefined">
          <span>CVD 1m:</span><span>{{ contextMenu.data.cvd1m !== null ? contextMenu.data.cvd1m.toFixed(0) : 'N/A' }}</span>
        </div>
      </div>
    </div>

    <div class="update-info">
      <span>Last updated: {{ currentTime | date:'medium' }}</span>
      <span class="auto-refresh">Auto-refreshes every 10 seconds</span>
    </div>
  </div>

  <div *ngIf="!loading && !error && !symbolData" class="no-data">
    <p>No data available for {{ selectedSymbol }}</p>
  </div>
</div>
